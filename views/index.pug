extends layout

block content
  div.content-container
    div.title-container(style="margin-bottom: 20px; text-align: center;")
      h1 Beredskapskart

    // Kart og sidebar i felles container
    div.map-and-sidebar(style="display: flex; height: 600px;")
      // Sidebar-meny
      div.sidebar#sidebar(class="open")
        button.menu-toggle(type="button", style="position: absolute; top: 10px; right: 10px;") ☰
        h2(style="margin-top: 0; text-align: center;") Lagkontroller
        div.layer-controls(style="margin-top: 20px")
          div.layer-control-item(style="display: flex; align-items: center; justify-content: flex-start; width: 100%; padding: 0.5em 0.8em; background-color: #cce2e8; border: 2px solid #bbcad5; border-radius: 4px; box-sizing: border-box;")
            input(type="checkbox", id="shelter-checkbox", checked)
            label(for="shelter-checkbox")
              | Alternativt tilfluktsrom
              img(src="/assets/tent-7-svgrepo-com.svg", alt="Shelter", style="width: 20px; height: 20px; vertical-align: middle; margin-left: 4px;")
          div.layer-control-item(style="display: flex; align-items: center; justify-content: flex-start; width: 100%; padding: 0.5em 0.8em; background-color: #cce2e8; border: 2px solid #bbcad5; border-radius: 4px; box-sizing: border-box; ")
            input(type="checkbox", id="bunker-checkbox", checked)
            label(for="bunker-checkbox")
              | Offentlig tilfluktsrom
              img(src="/assets/bunker-svgrepo-com-3.svg", alt="Tilfluktsrom", style="width: 20px; height: 20px; vertical-align: middle; margin-left: 4px;")
          div.layer-control-item(style="display: flex; align-items: center; justify-content: flex-start; width: 100%; padding: 0.5em 0.8em; background-color: #cce2e8; border: 2px solid #bbcad5; border-radius: 4px; box-sizing: border-box;")
            input(type="checkbox", id="position-checkbox", checked)
            label(for="position-checkbox")
              | Min posisjon
              img(src="https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png", alt="Min posisjon", style="width: 12px; height: 20px; vertical-align: middle; margin-left: 4px;")
          div.layer-control-item(style="display: flex; align-items: center; justify-content: flex-start; width: 100%; padding: 0.5em 0.8em; background-color: #cce2e8; border: 2px solid #bbcad5; border-radius: 4px; box-sizing: border-box;")
            input(type="checkbox", id="custom-checkbox", checked)
            label(for="custom-checkbox")
              | Valgt posisjon
              img(src="https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-violet.png", alt="Valgt posisjon", style="width: 12px; height: 20px; vertical-align: middle; margin-left: 4px;")
          div.layer-control-item(style="display: flex; align-items: center; justify-content: flex-start; width: 100%; padding: 0.5em 0.8em; background-color: #cce2e8; border: 2px solid #bbcad5; border-radius: 4px; box-sizing: border-box;")
            input(type="checkbox", id="route-checkbox", checked)
            label(for="route-checkbox") Tilfluktsromsrute
          div.layer-control-item(style="display: flex; align-items: center; justify-content: flex-start; width: 100%; padding: 0.5em 0.8em; background-color: #cce2e8; border: 2px solid #bbcad5; border-radius: 4px; box-sizing: border-box;")
            input(type="checkbox", id="population-checkbox")
            label(for="population-checkbox") Befolkning
          div.layer-control-item(style="display: flex; align-items: center; justify-content: flex-start; width: 100%; padding: 0.5em 0.8em; background-color: #cce2e8; border: 2px solid #bbcad5; border-radius: 4px; box-sizing: border-box;")
            input(type="checkbox", id="isochrone-checkbox")
            label(for="isochrone-checkbox")
              | Tilgjengelighet (Gåavstand)
              span(style="display: inline-block; width: 20px; height: 8px; background: linear-gradient(to right, #e6c3ff, #9966cc); margin-left: 4px; vertical-align: middle;")
          div.layer-control-item(
            style="display:flex; align-items:center; justify-content:center; width:100%; padding:0.5em 0.8em; background-color:white; border:2px solid #bbcad5; border-radius:4px; box-sizing:border-box;"
          )
            button#show-all-isochrones-button(
              style="width:100%; padding:0.6em 0.8em; background-color:#2E7D32; color:white; border:none; border-radius:4px; cursor:pointer; font-weight:600;"
            ) Vis alle isokroner
          div.layer-control-item(
            style="display:flex; align-items:center; justify-content:center; width:100%; padding:0.5em 0.8em; background-color:white; border:2px solid #bbcad5; border-radius:4px; box-sizing:border-box;"
          )
            button#clear-isochrones-button(
              style="width:100%; padding:0.6em 0.8em; background-color:#f44336; color:white; border:none; border-radius:4px; cursor:pointer; font-weight:600;"
            ) Fjern alle isokroner

      // Kartet
      div.map-container(style="flex: 1; position: relative;")
        div#map

      img(
              src="/assets/icon-compass.svg",
              alt="Kompass",
              id="compass-icon" 
            )

    // Position info panel - Added here
    div.position-info-container(style="margin-top: 20px; padding: 15px; background-color: #97bac2; border: #bbcad5 2px solid; border-radius: 8px; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);")
      h3(style="margin-bottom: 10px; color: #333;") Valgt <Posisjon></Posisjon>
      div#position-info(style="background-color: #cce2e8; padding: 15px; border-radius: 6px; color: #333;") Klikk på kartet for å velge en posisjon og se informasjon her.

    div.analysis-container(style="margin-top: 20px; padding: 15px; background-color: #97bac2; border: #bbcad5 2px solid; border-radius: 8px; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);")
      h3(style="margin-bottom: 10px;") Befolkning og Kapasitetsanalyse
      p#analysis-info Tegn et område på kartet for å analysere befolkning og tilfluktsromkapasitet.
      div#analysis-results(style="display: none;")
        div(style="display: flex; justify-content: space-between; margin-top: 10px;")
          div(style="flex: 1; padding: 10px; background-color: #cce2e8; border-radius: 4px; margin-right: 10px;")
            h4 Befolkning
            p#population-count 0 personer
          div(style="flex: 1; padding: 10px; background-color: #cce2e8; border-radius: 4px; margin-right: 10px;")
            h4 Tilfluktsromskapasitet
            p#shelter-capacity 0 plasser
          div(style="flex: 1; padding: 10px; background-color: #cce2e8; border-radius: 4px;")
            h4 Dekningsgrad
            p#coverage-percentage 0%
      button#clear-analysis(style="margin-top: 15px; padding: 8px 15px; background-color: #cce2e8; border: 1px solid #ddd; border-radius: 4px; cursor: pointer;") Fjern analyse

    div.info-container
      div.left
        h3 Hva er dette verktøyet?
        p I en krisesituasjon er tilgang til trygge tilfluktsrom avgjørende for befolkningens sikkerhet. I Agder fylke bor det 319 644 personer, men kapasiteten i offentlige tilfluktsrom er kun 16 773 plasser. Dette betyr at det i gjennomsnitt er 1 plass per 19 innbyggere, noe som indikerer en alvorlig mangel på tilgjengelige tilfluktsrom.
        br
        p Denne applikasjonen undersøker følgende spørsmål:
        br
        p Er det nok tilfluktsrom i Agder til å dekke behovet i en krisesituasjon? Hvilke områder har størst kapasitetsutfordringer? Kan alternativer, som enkle "basic huts" fra OpenStreetMap, bidra til å gi inbyggere tilfluktssteder?
      div.right
        h3 Hvordan bruker jeg dette verktøyet?
        ul
          li Bruk lagkontrollene for å skru av/på lag.
          li Tegn et område på kartet for å analysere befolkning og tilfluktsromkapasitet.
          li Klikk på et tilfluktsrom for å se detaljer.
          li Klikk på en rute for å se befolkningsdetaljer.
          li Klikk på kartet for legge inn markør og se avstand til nærmeste tilfluktsrom.

    div.population-link-container(style="margin-top: 20px; text-align: center;")
      a.population-link(href="/population", style="display: inline-block; padding: 12px 24px; background-color: #d49044; color: black; text-decoration: none; border-radius: 4px; font-weight: bold; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2); transition: background-color 0.3s ease;") 
        | Se detaljert befolkningskart
        span(style="margin-left: 8px;") →

  //- Add the environment variables script BEFORE the data scripts
  script.
    //- Create a global ENV object to store environment variables
    window.ENV = {
      ORS_API_KEY: '#{orsApiKey}'  //- This will be replaced with the value from the server
    };

  script.
    window.shelterData = !{shelterData || 'null'};
    window.bunkerData = !{bunkerData || 'null'};
    window.populationData = !{populationData || 'null'};
    window.isochroneData = !{isochroneData || 'null'};

  script(
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  )
  script(src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js" crossorigin="")
  script(src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.8.0/proj4.js")
  script(src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js")
  script(src='/js/main.js' type='module')

  // Toggle sidebar
  script.
    document.addEventListener('DOMContentLoaded', function () {
      const toggleButton = document.querySelector('.menu-toggle');
      const sidebar = document.getElementById('sidebar');

      if (toggleButton && sidebar) {
        toggleButton.addEventListener('click', () => {
          sidebar.classList.toggle('closed');
          toggleButton.textContent = sidebar.classList.contains('closed') ? '▶' : '◀';
        });

        toggleButton.textContent = sidebar.classList.contains('closed') ? '▶' : '◀';
      }
    });
    